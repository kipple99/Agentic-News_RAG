"""
Relevance Check 프롬프트 템플릿
관련성 판단을 위한 상세한 프롬프트
"""

def get_relevance_check_prompt(
    sub_query: str,
    es_score: float,
    context_snippet: str,
    user_query: str = "",
    needs_recent_info: bool = False
) -> str:
    """
    관련성 판단 프롬프트 생성
    
    Args:
        sub_query: 평가할 서브쿼리
        es_score: Elasticsearch RRF 점수
        context_snippet: 검색된 문서의 스니펫
        user_query: 원본 사용자 질문 (선택)
        needs_recent_info: 최신 정보 필요 여부
    
    Returns:
        완성된 프롬프트 문자열
    """
    
    score_interpretation = ""
    if es_score >= 0.7:
        score_interpretation = "매우 높은 관련성 (0.7 이상)"
    elif es_score >= 0.5:
        score_interpretation = "높은 관련성 (0.5-0.7)"
    elif es_score >= 0.3:
        score_interpretation = "중간 관련성 (0.3-0.5)"
    else:
        score_interpretation = "낮은 관련성 (0.3 미만)"
    
    time_instruction = ""
    if needs_recent_info:
        time_instruction = """
**시간 민감성 처리:**
- 원본 질문에 시간 관련 키워드가 포함되어 있습니다.
- 내부 DB 문서가 오래된 정보일 가능성이 높습니다.
- 최신 정보가 필요하므로 "web"으로 판단하세요.
"""
    
    prompt = f"""당신은 검색 결과의 관련성과 충분성을 평가하는 전문가입니다. 내부 DB 검색 결과만으로 사용자 질문에 충분히 답할 수 있는지 판단하세요.

## 역할 및 목표
- 내부 DB 검색 결과의 관련성 평가
- 검색 결과만으로 질문에 답할 수 있는지 판단
- 추가 웹 검색 필요 여부 결정

## 입력 정보

**원본 사용자 질문:**
{user_query if user_query else "(제공되지 않음)"}

**평가할 서브쿼리:**
"{sub_query}"

**Elasticsearch RRF 점수:**
{es_score:.4f} ({score_interpretation})

**내부 DB 검색 결과 (상위 3개 문서):**
{context_snippet if context_snippet else "검색된 문서가 없습니다."}

## 판단 기준

### "db" (내부 DB로 충분) 판단 조건
다음 조건을 모두 만족하면 "db"로 판단하세요:

1. **관련성 충족:**
   - 검색 결과가 서브쿼리와 직접적으로 관련됨
   - ES 점수가 0.5 이상
   - 검색 결과에 핵심 정보가 포함됨

2. **정보 충분성:**
   - 검색 결과만으로 질문에 답할 수 있음
   - 핵심 사실, 데이터, 설명이 포함됨
   - 추가 정보가 크게 필요하지 않음

3. **시간 민감성 없음:**
   - 질문이 시간에 민감하지 않음
   - 최신 정보가 필수적이지 않음
   - 일반적인 지식이나 과거 정보로 충분

4. **정보 품질:**
   - 검색 결과가 신뢰할 만한 정보
   - 구체적이고 명확한 내용
   - 모호하거나 불완전하지 않음

### "web" (웹 검색 필요) 판단 조건
다음 중 하나라도 해당하면 "web"으로 판단하세요:

1. **관련성 부족:**
   - 검색 결과가 서브쿼리와 관련이 낮음
   - ES 점수가 0.3 미만
   - 검색 결과가 질문과 맞지 않음

2. **정보 부족:**
   - 검색 결과만으로는 답변 불충분
   - 핵심 정보가 누락됨
   - 추가 정보나 맥락이 필요함

3. **시간 민감성:**
   - 질문에 "오늘", "최신", "최근", "현재" 등 시간 키워드 포함
   - 최신 정보가 필수적
   - 내부 DB 문서가 오래되었을 가능성
   {time_instruction}

4. **정보 품질 문제:**
   - 검색 결과가 모호하거나 불완전함
   - 신뢰성이 낮거나 출처 불명확
   - 여러 관점이나 추가 검증 필요

5. **비교/분석 요구:**
   - 여러 항목 비교가 필요함
   - 복합적인 분석이 필요함
   - 다양한 출처의 정보 필요

## 판단 프로세스

1단계: ES 점수 확인
- 0.7 이상: 매우 높은 관련성 → "db" 가능성 높음
- 0.5-0.7: 높은 관련성 → 내용 확인 필요
- 0.3-0.5: 중간 관련성 → "web" 가능성 높음
- 0.3 미만: 낮은 관련성 → "web" 권장

2단계: 검색 결과 내용 확인
- 서브쿼리의 핵심 키워드가 결과에 포함되는가?
- 질문에 답할 수 있는 정보가 있는가?
- 정보가 구체적이고 명확한가?

3단계: 시간 민감성 확인
- 원본 질문에 시간 관련 키워드가 있는가?
- 최신 정보가 필요한 질문인가?
- 내부 DB 문서의 날짜가 최신인가?

4단계: 최종 판단
- 위 기준을 종합하여 "db" 또는 "web" 결정

## 출력 형식
반드시 다음 중 하나만 출력하세요:
- "web" → 웹 검색 필요
- "db" → 내부 DB로 충분

추가 설명이나 마크다운 없이 순수하게 "web" 또는 "db"만 출력하세요.

## 판단 예시

예시 1:
서브쿼리: "2024년 자동차 산업 최신 뉴스"
ES 점수: 0.65
검색 결과: "2019년 자동차 산업 동향..." (오래된 정보)
판단: "web" (최신 정보 필요)

예시 2:
서브쿼리: "RAG 개념 설명"
ES 점수: 0.82
검색 결과: "RAG(Retrieval-Augmented Generation)는..." (명확한 설명)
판단: "db" (충분한 정보)

예시 3:
서브쿼리: "대한항공 실적 현황"
ES 점수: 0.45
검색 결과: "항공 산업 일반 정보..." (관련성 낮음)
판단: "web" (관련성 부족)

## 주의사항
1. ES 점수만으로 판단하지 말고 내용을 반드시 확인하세요.
2. 시간 관련 키워드가 있으면 대부분 "web"이 적절합니다.
3. 모호한 경우 보수적으로 "web"을 선택하세요.
4. 출력은 반드시 "web" 또는 "db"만 하세요.

이제 위 기준에 따라 판단하세요."""
    
    return prompt


